name: Coverage Preview

on:
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: coverage-${{ github.ref }}
  cancel-in-progress: true

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: "8.15.4"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate coverage
        run: pnpm turbo run test:coverage

      - name: Prepare coverage site
        shell: bash
        run: |
          set -euo pipefail
          rm -rf coverage_preview
          mkdir -p coverage_preview/coverage
          find packages -type d -path "*/coverage" -not -path "*/node_modules/*" -print0 \
            | while IFS= read -r -d  dir; do
                rel=${dir#packages/}
                mkdir -p "coverage_preview/coverage/${rel}"
                cp -R "$dir/." "coverage_preview/coverage/${rel}/"
              done
          reports=$(find coverage_preview/coverage -path "*/coverage/index.html" | sort)
          cat > coverage_preview/coverage/index.html <<HTML
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Coverage Preview</title>
    <style>
      body { font-family: system-ui, sans-serif; padding: 2rem; line-height: 1.5; }
      ul { padding-left: 1.5rem; }
      li { margin-bottom: 0.5rem; }
      a { color: #2563eb; text-decoration: none; }
      a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <h1>Coverage Reports</h1>
    <p>Select a package to view its HTML coverage report.</p>
    <ul>
HTML
          if [ -z "$reports" ]; then
            echo "      <li>No coverage reports generated.</li>" >> coverage_preview/coverage/index.html
          else
            while read -r report; do
              pkg=${report#coverage_preview/coverage/}
              pkg=${pkg%/coverage/index.html}
              echo "      <li><a href=\"${pkg}/coverage/index.html\">${pkg}</a></li>" >> coverage_preview/coverage/index.html
            done <<< "$reports"
          fi
          cat >> coverage_preview/coverage/index.html <<HTML
    </ul>
  </body>
</html>
HTML
          cat > coverage_preview/index.html <<HTML
<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="refresh" content="0; url=./coverage/">
    <title>Redirecting…</title>
  </head>
  <body>
    <p>Redirecting to <a href="./coverage/">coverage</a>…</p>
  </body>
</html>
HTML

      - name: Coverage summary
        shell: bash
        run: |
          set -euo pipefail
          cat > coverage-preview-summary.mjs <<NODE
import fs from "node:fs";
const [,, file, pkg] = process.argv;
const data = JSON.parse(fs.readFileSync(file, "utf8"));
const totals = data.total || {};
const fmt = (metric) => metric && typeof metric.pct === "number" ? `${metric.pct.toFixed(2)}%` : "0%";
console.log(`\n### ${pkg}`);
console.log(`- Lines: ${fmt(totals.lines)}`);
console.log(`- Statements: ${fmt(totals.statements)}`);
console.log(`- Branches: ${fmt(totals.branches)}`);
console.log(`- Functions: ${fmt(totals.functions)}`);
NODE
          summaries=$(find coverage_preview/coverage -name coverage-summary.json || true)
          echo "## Coverage Summary" >> "$GITHUB_STEP_SUMMARY"
          if [ -z "$summaries" ]; then
            echo "No coverage reports generated." >> "$GITHUB_STEP_SUMMARY"
          else
            while read -r summary; do
              [ -z "$summary" ] && continue
              pkg=${summary#coverage_preview/coverage/}
              pkg=${pkg%/coverage/coverage-summary.json}
              node coverage-preview-summary.mjs "$summary" "$pkg" >> "$GITHUB_STEP_SUMMARY"
            done <<< "$summaries"
          fi

      - name: Upload coverage preview
        uses: actions/upload-pages-artifact@v3
        with:
          path: coverage_preview

  deploy:
    needs: coverage
    runs-on: ubuntu-latest
    environment:
      name: preview
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy preview
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          preview: true
