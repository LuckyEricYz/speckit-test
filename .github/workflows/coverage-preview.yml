name: Coverage Preview

on:
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: coverage-${{ github.ref }}
  cancel-in-progress: true

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: "8.15.4"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate coverage
        run: pnpm turbo run test:coverage

      - name: Prepare coverage site
        run: |
          rm -rf coverage_preview
          mkdir -p coverage_preview
          find packages -type d -path "*/coverage" -not -path "*/node_modules/*" -print0 \
            | while IFS= read -r -d '' dir; do
                rel=${dir#packages/}
                mkdir -p "coverage_preview/${rel}"
                cp -R "$dir/." "coverage_preview/${rel}/"
              done
          reports=$(find coverage_preview -path "*/coverage/index.html" | sort)
          summaries=$(find coverage_preview -path "*/coverage/coverage-summary.json" | sort)
          cat <<'HTML' > coverage_preview/index.html
          <!doctype html>
          <html lang="en">
            <head>
              <meta charset="UTF-8">
              <title>Coverage Preview</title>
              <style>
                :root { color-scheme: light dark; }
                body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 2rem; line-height: 1.5; max-width: 960px; margin: 0 auto; }
                h1 { margin-bottom: 1rem; }
                section { margin-top: 2rem; }
                ul { padding-left: 1.5rem; }
                li { margin-bottom: 0.5rem; }
                a { color: #2563eb; text-decoration: none; }
                a:hover { text-decoration: underline; }
                .table-wrapper { overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
                table { width: 100%; border-collapse: collapse; min-width: 480px; }
                thead { background: #f8fafc; }
                th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; font-variant-numeric: tabular-nums; }
                th { font-size: 0.85rem; letter-spacing: 0.05em; text-transform: uppercase; color: #64748b; }
                tbody tr:last-child td { border-bottom: 0; }
                .empty { color: #6b7280; font-style: italic; }
              </style>
            </head>
            <body>
              <h1>Coverage Reports</h1>
              <p>Review the coverage summary for each package, then open the HTML reports for full details.</p>
              <section>
                <h2>Package Coverage Summary</h2>
          HTML
          if [ -z "$summaries" ]; then
            echo "                <p class=\"empty\">No coverage summaries generated.</p>" >> coverage_preview/index.html
          else
            cat <<'HTML' >> coverage_preview/index.html
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Package</th>
                        <th>Statements</th>
                        <th>Branches</th>
                        <th>Functions</th>
                        <th>Lines</th>
                      </tr>
                    </thead>
                    <tbody>
            HTML
            printf '%s\n' "$summaries" \
              | node <<'NODE' >> coverage_preview/index.html
const fs = require("fs");

const files = fs.readFileSync(0, "utf8").trim().split("\n").filter(Boolean);
const formatPct = (pct) => {
  if (!Number.isFinite(pct)) return "N/A";
  return `${pct % 1 === 0 ? pct.toString() : pct.toFixed(1)}%`;
};

for (const file of files) {
  try {
    const data = JSON.parse(fs.readFileSync(file, "utf8"));
    const total = data.total || {};
    const pkg = file
      .replace(/^coverage_preview\//, "")
      .replace(/\/coverage\/coverage-summary\.json$/, "");
    const values = [
      pkg,
      formatPct(total.statements?.pct),
      formatPct(total.branches?.pct),
      formatPct(total.functions?.pct),
      formatPct(total.lines?.pct)
    ];
    process.stdout.write("                      <tr>\n");
    process.stdout.write(`                        <td>${values[0]}</td>\n`);
    for (let i = 1; i < values.length; i++) {
      process.stdout.write(`                        <td>${values[i]}</td>\n`);
    }
    process.stdout.write("                      </tr>\n");
  } catch (error) {
    // Ignore malformed files
  }
}
NODE
            cat <<'HTML' >> coverage_preview/index.html
                    </tbody>
                  </table>
                </div>
            HTML
          fi
          cat <<'HTML' >> coverage_preview/index.html
              </section>
              <section>
                <h2>HTML Reports</h2>
                <p>Select a package to view its HTML coverage report.</p>
                <ul>
          HTML
          if [ -z "$reports" ]; then
            echo "                  <li>No coverage reports generated.</li>" >> coverage_preview/index.html
          else
            while read -r report; do
              pkg=${report#coverage_preview/}
              pkg=${pkg%/coverage/index.html}
              echo "                  <li><a href=\"${pkg}/coverage/index.html\">${pkg}</a></li>" >> coverage_preview/index.html
            done <<< "$reports"
          fi
          cat <<'HTML' >> coverage_preview/index.html
                </ul>
              </section>
            </body>
          </html>
          HTML

      - name: Upload coverage preview
        uses: actions/upload-pages-artifact@v3
        with:
          path: coverage_preview

  deploy:
    needs: coverage
    runs-on: ubuntu-latest
    environment:
      name: preview
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy preview
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          preview: true
